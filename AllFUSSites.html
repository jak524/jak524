<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>FUS Sites by indication</title>
  <style>
    html, 
    body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    
    #viewDiv {
      float: left;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 80%;
    }

      
    table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }
  #feature-node {
       float: left;
        width: 20%;
        height: 90%;
        padding-left: 10px;
        overflow-y: auto;
      }
      #menu {
        display: flex;
        justify-content: center;
        align-items: center;
      }

  #clearButton, #selectAllButton {
    display: inline-block;
    padding:0.3em 1.2em;
    margin:0 0.3em 0.3em 0;
    float: none;
    margin-right: 10px;
    background-color: #4095c6;
    border-radius:2em;
    border: 1px solid white;
    box-sizing: border-box;
    text-decoration: none;
    color: #FFFFFF;
    text-align: center;
    transition: all 0.2s;
  }

  #clearButton:hover, #resetButton:hover{
    background-color: #007aff;
  }
  </style>

  <!-- default arcgis light css for page -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css">

  <!-- arcgis library import -->
  <script src="https://js.arcgis.com/4.21/"></script>

  <!-- jquery import -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

  <!-- creating json array of data for legend -->
  <script type="text/javascript">
  var conditionLayer;
  var infos;
 </script>

<!-- main js functions -->
  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Locate",
      "esri/widgets/Search",
      "esri/smartMapping/statistics/uniqueValues"

  ], 
  
  function(esriConfig,Map, SceneView,FeatureLayer,Locate,Search,uniqueValues) {

    esriConfig.apiKey = "AAPK9dcac5f3dbb74f4e924ea2b8be48fd1bL0juwLZcptMZ_z2QomWaZbSPJ2dSWgA4a3Zsh7SSWwqkAWDtnYQng7M8dNkjZyiD";  

    const map = new Map({
      basemap: "hybrid", //Basemap layer service
    });

    const indications = {}


   //Build renderer 

      const conditionRenderer = {
        "type": "simple",
        "symbol": {
          "type": "simple-marker",
          "style": "circle",
          "color": "red",
          "size": "10px"
        }
      };

      //setup pop-ups
      const popupCondition = {
        "title": "{Name}",
        "content": "<Table><TR><TD><b>Address:</b></TD><TD>{Address}</TD></TR><TR><TD><b>Directions:</b></TD><TD><A HREF=\"{Directions}\">View</A></TD></TR><TR><TD><b>Website:</b></TD><TD><A HREF=\"{Website}\">View</A></TD></TR><TR><TD><b>FUSF Website:</b></TD><TD><A HREF=\"{FUSF_Website}\">View</A></TD></TR><TR><TD><b>Condition(s):</b></TD><TD>{Indication_List}</TD></TR></Table>"      
      }

     
    
//Add Feature layer
conditionLayer = new FeatureLayer({
    //URL comes from content page on arcgis.com for this particular layer, it needs to be public
    url: "https://services1.arcgis.com/Fi2lZwxhOuzNdfY8/arcgis/rest/services/All_Sites_1_6_2022/FeatureServer",
    renderer: conditionRenderer,
    id: "condition",
    title: "Sites by Condition",
    visible: true,
    popupTemplate: popupCondition
  });

 //Get list of all indications

uniqueValues({
  layer: conditionLayer,
  field: "Indication",

  view: map
  }).then(function (response) {
    // prints each unique value and the count of features containing that value
    this.infos = response.uniqueValueInfos;
    //console.log(this.infos);
    $.each(this.infos, function () {
      var $featureNode = $("#feature-node").get();
      var $label = $("<label>").text(this.value);
      //console.log(this.count);
      //var $count = $(this.count);
      $("#feature-node").append($("<div>").append($($label).append( " (" + this.count + ")").prepend(
        $("<input>").attr('type', 'checkbox').val(this.value).attr('onClick','filterFunction()')
          .prop('checked', true)
          .prop('name', "checkbox")
          .prop('class', this.value)
    )));
  //$("#feature-node").append(this.count);
  });
});

//add filter checkboxes for IDType

$("#menu").append('<input type="checkbox" id="Commercial" name="typeID" checked="true" value="0122A000000s3qgQAA" onClick="filterByType()">').append('<label for="Commercial">Commercial</label></div>');
$("#menu").append('<input type="checkbox" id="Clinical" name="typeID" checked="true" value="0122A000000s3qfQAA" onClick="filterByType()"">').append('<label for="Clinical">Clinical</label></div>');
$("#menu").append('<input type="checkbox" id="Pre-Clinical" name="typeID" checked="true" value="0122A000000s3qiQAA" onClick="filterByType()"">').append('<label for="Pre-Clinical">Pre-Clinical</label></div><br>');


//setup buttons
    $("#menu").append($("<br>"));
 //    $("#menu").append($("<input>").attr({type: 'button', id: 'filterButton', value: 'Filter', onclick: 'filterFunction()'}));
     $("#menu").append($("<input>").attr({type: 'button', id: 'clearButton', value: 'Clear', onclick: 'clearFunction()'}));
     $("#menu").append($("<input>").attr({type: 'button', id: 'selectAllButton', value: 'Select All', onclick: 'selectAllFunction()'}));

   map.add(conditionLayer);

    const view = new SceneView({
      container: "viewDiv",
      map: map,
      widthBreakpoint: 'xlarge',
      camera: {
        position: {
          x: -118.808, //Longitude
          y: 33.961, //Latitude
          z: 10000000 //Meters
        },
        
      }
      });
      const searchWidget = new Search({
          view: view,
          
        });
  view.ui.add(searchWidget, "top-right"); //Add to the map
  //Add items to page
    // Add the locate widget to the top left corner of the view, to find your current location
      const locateBtn = new Locate({
          view: view
        });
        view.ui.add(locateBtn, {
          position: "top-left"
        });
});


function filterFunction() {
  //Determine which items have been checked and filter based on that
  var queryString;
  var itemCount = 0;
  var currentItem;
  const checkboxes = document.querySelectorAll(`input[name=checkbox]:checked`);
    let values = [];
    checkboxes.forEach((checkbox) => {
        itemCount += 1;
        currentItem = checkbox.value
        
        //need to double up so SQL will recognize '
        currentItem = currentItem.replace('\'','\'\'');
        if (itemCount <2) {
          queryString = "Indication = '" + currentItem + "'";
        }
        else{
          queryString += " OR Indication =  '" + currentItem + "'";
        }
    });

    if (queryString != null) //Do nothing if they hit filter with nothing checked.
    {
       conditionLayer.definitionExpression = queryString;
    }else{
       conditionLayer.definitionExpression = "Indication = ''";
    }
  
}
function clearFunction() {
  //Set all checkboxes to empty and run blank query
  var ele=document.getElementsByName('checkbox');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=false;  
                }  
  conditionLayer.definitionExpression = "Indication = ''";
}
function selectAllFunction() {
  //set all checkboxes to checked and select all indications
  var ele=document.getElementsByName('checkbox');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=true;  
                }  
   conditionLayer.definitionExpression = "";
}
function filterByType() {
  //Determine which Types have been checked
  var queryString;
  var itemCount = 0;
  var currentItem;
  const checkboxes = document.querySelectorAll(`input[name=typeID]:checked`);
    let values = [];
    checkboxes.forEach((checkbox) => {
        itemCount += 1;
        currentItem = checkbox.value
        
        //need to double up so SQL will recognize '
        currentItem = currentItem.replace('\'','\'\'');
        if (itemCount <2) {
          queryString = "RecordType = '" + currentItem + "'";
        }
        else{
          queryString += " OR RecordType =  '" + currentItem + "'";
        }
    });

    if (queryString != null) //Do nothing if they hit filter with nothing checked.
    {
       conditionLayer.definitionExpression = queryString;
    }else{
       conditionLayer.definitionExpression = "RecordType = ''";
    }
  
}

  </script>

<body>
  <div id="feature-node" class="esri-widget" style="overflow-y:auto">
    <div id= "menu" style="height: 10%; width: 20%; display:block; position:fixed;background-color: #FFFFFF; ">
    </div>
  </br>
  </br>
</br>
</br>
</br>
    <h2>Conditions</h2>
  </div>
  
</div>
  <div id="viewDiv"></div>
</body>
