<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>FUS Sites by indication</title>
  <style>
    html, 
    body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    
    #viewDiv {
      float: left;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 80%;
    }

      
    table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }
  #feature-node {
       float: left;
        width: 20%;
        height: 90%;
        padding-left: 10px;
        overflow-y: auto;
      }
      #menu {
        display: flex;
        justify-content: center;
        align-items: center;
      }

  #clearButton, #selectAllButton {
    display: inline-block;
    padding:0.3em 1.2em;
    margin:0 0.3em 0.3em 0;
    float: none;
    margin-right: 10px;
    background-color: #4095c6;
    border-radius:2em;
    border: 1px solid white;
    box-sizing: border-box;
    text-decoration: none;
    color: #FFFFFF;
    text-align: center;
    transition: all 0.2s;
  }

  #clearButton:hover, #resetButton:hover{
    background-color: #007aff;
  }
  </style>

  <!-- default arcgis light css for page -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css">

  <!-- arcgis library import -->
  <script src="https://js.arcgis.com/4.21/"></script>

  <!-- jquery import -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
  <script src="jquery-csv.js"></script>
  <!-- creating json array of data for legend -->
  <script type="text/javascript">
  var conditionLayer;
  //var infos;
  var originalList;
  var infos2;

 
 </script>

<!-- main js functions -->
  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Locate",
      "esri/widgets/Search",
      "esri/smartMapping/statistics/uniqueValues"

  ], 
  
  function (esriConfig,Map, SceneView,FeatureLayer,Locate,Search,uniqueValues) {

    esriConfig.apiKey = "AAPK9dcac5f3dbb74f4e924ea2b8be48fd1bL0juwLZcptMZ_z2QomWaZbSPJ2dSWgA4a3Zsh7SSWwqkAWDtnYQng7M8dNkjZyiD";  

    const map = new Map({
      basemap: "hybrid", //Basemap layer service
    });

    const indications = {}


   //Build renderer, in this version, all red circles

      const conditionRenderer = {
        "type": "simple",
        "symbol": {
          "type": "simple-marker",
          "style": "circle",
          "color": "red",
          "size": "10px"
        }
      };

      //setup pop-ups
      const popupCondition = {
        "title": "{Name}",
        //"content": "<Table><TR><TD><b>Address:</b></TD><TD>{Address}</TD></TR><TR><TD><b>Directions:</b></TD><TD><A HREF=\"{Directions}\">View</A></TD></TR><TR><TD><b>Website:</b></TD><TD><A HREF=\"{Website}\">View</A></TD></TR><TR><TD><b>More Info:</b></TD><TD><A HREF=\"{FUSF_Website}\">View</A></TD></TR><TR><TD><b>Condition(s):</b></TD><TD>{Indication_List}</TD></TR></Table>"      
        "content": "<Table><TR><TD><b>Address:</b></TD><TD>{Address}</TD></TR><TR><TD><b>Directions:</b></TD><TD><A HREF=\"{Directions}\">View</A></TD></TR><TR><TD><b>More Info:</b></TD><TD><A HREF=\"{FUSF_Website}\">View</A></TD></TR></Table>"      
   
      }

  
    
//Add Feature layer
conditionLayer = new FeatureLayer({
    //URL comes from content page on arcgis.com for this particular layer, it needs to be public
    url: "https://services1.arcgis.com/Fi2lZwxhOuzNdfY8/arcgis/rest/services/All_Sites_1_14_2022/FeatureServer",
    renderer: conditionRenderer,
    id: "condition",
    title: "Sites by Condition",
    visible: true,
    popupTemplate: popupCondition
  });

 //ArcGIS Function that produces a list of unique values on the layer, runs first time on its own.
uniqueValues({
  layer: conditionLayer,
  field: "Indication",
  view: map
  }).then(function (response) {
    // prints each unique value and the count of features containing that value for building checkboxes in left menu
    console.log("Original UV");
    this.infos = response.uniqueValueInfos;
    originalList = response.uniqueValueInfos;
    $.each(this.infos, function () {
      var currentValue = this.value;
        $("#feature-node").append('<input type="checkbox" id="' + currentValue +'" name="checkbox" checked="true" value="'+ currentValue + '" >').append('<label id="lbl' + currentValue +'" for="' + currentValue +'">' + currentValue + ' (' + this.count + ')</label></div><BR>');
        });
        var cbByIndication = document.querySelectorAll("input[type=checkbox][name=checkbox]");

    //Use Array.forEach to add an event listener to each checkbox.
    //Needs to be here to ensure it fires after the checkboxes are created
 
    cbByIndication.forEach(function(checkbox2) {
    checkbox2.addEventListener('change', function() {
      //if checkbox changes run filter then unique values functions
      console.log("Condition Checked/unchecked)")
      var forUV = filter();  
      uv(forUV);
  })
});
});

//add filter checkboxes for IDType

$("#menu").append('<input type="checkbox" id="Commercial" name="typeID" checked="true" value="0122A000000s3qgQAA">').append('<label for="Commercial">Commercial</label></div>');
$("#menu").append('<input type="checkbox" id="Clinical" name="typeID" checked="true" value="0122A000000s3qfQAA">').append('<label for="Clinical">Clinical</label></div>');
$("#menu").append('<input type="checkbox" id="Pre-Clinical" name="typeID" checked="true" value="0122A000000s3qiQAA">').append('<label for="Pre-Clinical">Pre-Clinical</label></div><br>');



//listen for ID Type checkbox changes
var cbByType = document.querySelectorAll("input[type=checkbox][name=typeID]");
// Use Array.forEach to add an event listener to each checkbox.
cbByType.forEach(function(checkbox) {
  checkbox.addEventListener('change', function() {
    console.log("Type Checked/unchecked)")
    var forUV = filter();  
    uv(forUV);

  })
});

//function to get unique values of features available on conditionLayer  the original one just runs the first time the page is loaded
function uv (bool){
  if(bool){
  uniqueValues({
    layer: conditionLayer,
    field: "Indication",
    view: map
    }).then(function (response) {
      // prints each unique value and the count of features containing that value
      console.log("New UV");
      this.infos2 = response.uniqueValueInfos;
      for(var i=0; i<originalList.length; i++){
        var found = false;
        var originalValue = originalList[i].value;
            $.each(infos2, function () {
                var filteredValue = this.value;
         
                if(originalList[i].value == this.value){
                    //Original list is first array of conditions with page loads
                    //filtered is currently displayed array of conditions
                    //If filtered list doesn't contain a value in original list, count should be 0, otherwise take count from new filtered value
                    document.getElementById("lbl" + this.value).innerHTML = this.value + " (" + this.count + ")";
                    found = true;
                    return false;
                 }
                });
            if(found == false){  //condition isn't in this dataset so set count to 0
                console.log("Condition set to 0")
                document.getElementById("lbl" + originalList[i].value).innerHTML = originalList[i].value + " (" + 0 + ")"; 
                
            }
    }
 }); 
}  
 else{ 
   console.log("False returned");
  for(var i=0; i<originalList.length; i++){
      document.getElementById("lbl" + originalList[i].value).innerHTML = originalList[i].value + " (" + 0 + ")";
  }
}
};
//setup buttons
    $("#menu").append($("<br>"));
    $("#menu").append($("<input>").attr({type: 'button', id: 'clearButton', value: 'Clear'}));
    $("#menu").append($("<input>").attr({type: 'button', id: 'selectAllButton', value: 'Select All'}));
    document.getElementById("clearButton").addEventListener("click",function(){
      clearFunction();
    });
    document.getElementById("selectAllButton").addEventListener("click",function(){
      selectAllFunction();
    });

    
   map.add(conditionLayer);

    const view = new SceneView({
      container: "viewDiv",
      map: map,
      widthBreakpoint: 'xlarge',
      camera: {
        position: {
          x: -118.808, //Longitude
          y: 33.961, //Latitude
          z: 10000000 //Meters
        },
        
      }
      });
     
      const searchWidget = new Search({
          view: view,
          
        });
  view.ui.add(searchWidget, "top-right"); //Add to the map
  //Add items to page
    // Add the locate widget to the top left corner of the view, to find your current location
      const locateBtn = new Locate({
          view: view
        });
        view.ui.add(locateBtn, {
          position: "top-left"
        });


//Main filter function, calls other filters
function filter () {
var byIndication = filterFunction();
var byTypeID = filterByType();
var queryString = "Indication = ''";
//if either are blank, run a query that will clear all results
if (byTypeID == "" || byIndication == ""){
  conditionLayer.definitionExpression = queryString;
  console.log("no type or indication QS");
  return true;
}
//if (byIndication == ""){
 //       console.log("no Condition");
        //conditionLayer.visible = false;
 //       queryString = byTypeID;
 //   }
    else{
       // conditionLayer.visible = true;
        queryString = "(" + byIndication + ") AND " + "(" + byTypeID + ")" ;
    }
console.log("Running Filter QS=");
conditionLayer.definitionExpression = queryString;
return true;
};


function filterFunction() {
  //Determine which items have been checked and filter based on that
  var queryString = "";
  var itemCount = 0;
  var currentItem;
  const checkboxes = document.querySelectorAll(`input[name=checkbox]:checked`);
    let values = [];
    checkboxes.forEach((checkbox) => {
        itemCount += 1;
        currentItem = checkbox.value;
       
        //need to double up so SQL will recognize '
        currentItem = currentItem.replace('\'','\'\'');
        if (itemCount <2) {
          queryString = "Indication = '" + currentItem + "'";
        }
        else{
          queryString += " OR Indication =  '" + currentItem + "'";
        }
    });
return queryString;

}
function clearFunction() {
  //Set all checkboxes to empty and run blank query
  var ele=document.getElementsByName('checkbox');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=false;  
                }  
  //conditionLayer.definitionExpression = "Indication = ''";
  var forUV = filter();  
  uv(forUV);
}
function selectAllFunction() {
  //set all checkboxes to checked and select all indications
  var ele=document.getElementsByName('checkbox');  
                for(var i=0; i<ele.length; i++){  
                    if(ele[i].type=='checkbox')  
                        ele[i].checked=true;  
                }  
    var forUV = filter();  
    uv(forUV);
}
function filterByType() {
  //Determine which Types have been checked
  var queryString = "";
  var itemCount = 0;
  var currentItem;
  const checkboxes = document.querySelectorAll(`input[name=typeID]:checked`);
    let values = [];
    checkboxes.forEach((checkbox) => {
        itemCount += 1;
        currentItem = checkbox.value
        
        //need to double up so SQL will recognize '
        currentItem = currentItem.replace('\'','\'\'');
        if (itemCount <2) {
          queryString = "RecordType = '" + currentItem + "'";
        }
        else{
          queryString += " OR RecordType =  '" + currentItem + "'";
        }
    });

return queryString;
}
});
  </script>

<body>
  <div id="feature-node" class="esri-widget" style="overflow-y:auto">
    <div id= "menu" style="height: 10%; width: 20%; display:block; position:fixed;background-color: #FFFFFF; ">
    </div>
  </br>
  </br>
</br>
</br>
</br>
    <h2>Conditions</h2>
  </div>
  
</div>
  <div id="viewDiv"></div>
</body>